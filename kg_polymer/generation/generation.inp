#!/bin/bash
# ===============================================================
#  LAMMPS Simulation Setup Script
#  Author: Arman Moussavi
#
#  Description:
#    This script sets up and runs a simulation in two stages:
#      (1) A soft push-off phase to gently remove overlaps.
#      (2) A regular NPT simulation using full LJ interactions.
#
# ===============================================================


###############################################################
# 1. INITIAL SETUP
###############################################################

units       lj                 # Use Lennard-Jones reduced units
atom_style  full               # Atom style for bonded systems

# Read initial structure (define this variable externally)
read_data   ../write_initial_config/N10_chains100.data


###############################################################
# 2. SOFT PUSH-OFF PHASE
#    (Gently relax overlaps before running full LJ interactions)
###############################################################

# --- Pair interactions ---
pair_style  soft 1.12246
pair_coeff  * * 0.0

# --- Bond interactions ---
bond_style  fene
bond_coeff  1 30.0 1.5 1.0 1.0
special_bonds fene

# --- Angle interactions ---
angle_style none

# --- Improper interactions ---
improper_style none

# --- Neighbor and communication settings ---
neighbor    0.6 multi
comm_modify mode single cutoff 5.0

# --- Time integration and soft push-off ---
fix fix1 all nvt temp 1.0 1.0 1.0           # Constant NVT ensemble
variable prefactor equal ramp(0,100)        # Gradually increase force
fix softpushoff all adapt 1 pair soft a * * v_prefactor

# --- Output settings ---
thermo       1000
thermo_style custom step temp press vol density ke pe ebond eangle evdwl lx ly lz

# --- Run soft potential relaxation ---
timestep 0.002
run 10000

# --- Clean up ---
unfix fix1
unfix softpushoff


###############################################################
# 3. MAIN NPT SIMULATION
###############################################################

# --- Lennard-Jones pair potential ---
pair_style lj/cut 1.0
pair_coeff * * 1.0 1.0

# --- Bond and angle potentials (same as before) ---
bond_style  fene
bond_coeff  1 30.0 1.5 1.0 1.0
angle_style none
improper_style none

# --- Neighbor list and communication ---
neighbor    0.6 multi
comm_modify mode single cutoff 5.0

# --- NPT ensemble ---
fix fix1 all npt temp 1.0 1.0 1.0 iso 1.0 1.0 1.0

# --- Load balancing for parallel runs ---
balance 0.9 shift xyz 10 1.1
fix fix5 all balance 10000 0.9 shift xyz 10 1.1

# --- Output setup ---
dump dump2 all custom 1000 generation.lammpstrj id mol type x y z ix iy iz
dump_modify dump2 append no

thermo       1000
thermo_style custom step temp press vol density ke pe ebond eangle evdwl lx ly lz

# --- Reset and run ---
reset_timestep 0
run 100000


###############################################################
# 4. SAVE FINAL CONFIGURATION
###############################################################

write_data generation.data nocoeff nofix
